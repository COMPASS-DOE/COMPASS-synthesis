---
title: "rs-synthesis"
output: html_document
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
# Load packages
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(kableExtra)
library(forcats)

# Read in SRDB
read_csv("./rs/srdb-data.csv") %>% 
  select(Study_number, Author, Study_midyear, Ecosystem_type, 
         Manipulation, Manipulation_level, Rs_annual, Soil_drainage, Elevation) -> srdb

# Will turn this into a function once it works!!
# search_srdb <- function(srdb, data, column) {
#   # Function to search the Soil Respiration Database for specific data in a specified column
#   # Function will take in `srdb` (data frame of SRDB data), `data` a vector of values to search, and
#   # `column` chatacter string of the column name to search within; returns a dataframe with search results
#   
#   cat("Searching database for...", data,"...in the", column, "column")
#   
#   dplyr::filter(srdb, grepl(paste(data, collapse = "|"), x = column))
  
# }
```
##### This is a summary of the number of studies per manipulation for each ecosystem type in the SRDB.

### Manipulation Type Summaries {.tabset .tabset-pills}

#### Irrigation
```{r filter-manipulations, echo = FALSE, message = FALSE}

#search_srdb(srdb, data = hydro, column = 'Manipulation')

# Filter for studies with irrigation only manipulations
srdb %>% 
  #explain filter expression here
  filter(grepl("^Irrigat[a-z]*$", Manipulation, ignore.case = TRUE)) %>% 
  distinct(Study_number) %>% 
  left_join(srdb, by = "Study_number") %>%
  # Filter for rows with control and irrigation rows
  group_by(Study_number) %>% 
  filter(Manipulation == "None" |
           grepl("^Irrigat[a-z]*$", Manipulation, ignore.case = TRUE))  -> irrigation

# Summarise and count the number of studies
irrigation %>% 
  group_by(Ecosystem_type) %>% 
  summarise(n_studies = length(unique(Study_number))) %>% 
  mutate(M_Type = "Irrigated") %>% 
  arrange(desc(n_studies)) %>% 
  rename(Ecosystem_Type = Ecosystem_type) %>% 
  select(M_Type, Ecosystem_Type, n_studies) -> irr_summary

# Make table display
kable(irr_summary) %>% kable_styling(full_width = F)

#ADD COMMENT
irrigation %>% 
  filter(Ecosystem_type %in% c("Forest", "Grassland", "Agriculture")) %>%
  group_by(Ecosystem_type, Manipulation, Manipulation_level) %>% 
  summarise(n_obs = n())

irrigation %>% 
  filter(Manipulation == "None") %>% 
  group_by(Study_number, Ecosystem_type, Study_midyear) %>% 
  summarise(Rs_none = mean(Rs_annual, na.rm = TRUE)) %>% 
  filter(!is.na(Rs_none)) %>% 
  left_join(irrigation, by = c("Study_number", "Ecosystem_type", "Study_midyear")) %>% 
  mutate(rr = log(Rs_annual / Rs_none), 
         Study = paste(Author, floor(Study_midyear))) %>% 
  filter(Manipulation != "None")  -> irr_resp

  ggplot(irr_resp, aes(x = rr, y = fct_reorder(Author, rr))) + 
    geom_point(colour = "darkblue") + 
    geom_vline(xintercept = 0, linetype = "dashed") + 
    labs(x = "Response Ratio of Irrigation Studies", y = "Study") +
    theme_light()

```

#### Soil Drainage

```{r filter-soildrainage, echo = FALSE, message = FALSE}

drainage <- c("Dry", "Wet")
# Need studies that have BOTH dry and wet drainage 

srdb %>%   
  group_by(Study_number) %>% 
  dplyr::filter(grepl(paste(drainage, collapse = "|"), x = Soil_drainage)) %>% 
  # Count the number of unique soil drainage types per study 
  summarise(n_drain = length(unique(Soil_drainage))) %>% 
  # We only want studies with 2 or more soil drainage types
  filter(n_drain > 1) %>% left_join(srdb, by = "Study_number") -> drainage_type

drainage_type %>% 
  group_by(Ecosystem_type) %>% 
  summarise(n_studies = length(unique(Study_number))) %>% 
  mutate(M_Type = "Soil drainage") %>% 
  arrange(desc(n_studies)) %>% 
  rename(Ecosystem_Type = Ecosystem_type) %>% 
  select(M_Type, Ecosystem_Type, n_studies) -> drain_summary

kable(drain_summary) %>% kable_styling(full_width = F)

drainage_type %>% 
  filter(Ecosystem_type == c("Forest", "Grassland", "Agriculture")) %>% 
  group_by(Ecosystem_type, Soil_drainage) %>% 
  summarise(n_obs = n())

drainage_type %>% 
  filter(Manipulation == "None", Soil_drainage == "Wet") %>% 
  group_by(Study_number, Ecosystem_type, Study_midyear) %>% 
  summarise(Rs_wet = mean(Rs_annual, na.rm = TRUE)) %>% 
  filter(!is.na(Rs_wet)) %>% 
  left_join(drainage_type, by = c("Study_number", "Ecosystem_type", "Study_midyear")) %>% 
  filter(Soil_drainage == "Dry") %>% 
  mutate(rr = log(Rs_wet / Rs_annual), 
         Study = paste(Author, floor(Study_midyear))) -> drainage_resp

  ggplot(drainage_resp, aes(x = rr, y = fct_reorder(Author, rr))) + 
    geom_point(colour = "darkblue") + 
    geom_vline(xintercept = 0, linetype = "dashed") + 
    labs(x = "Response Ratio of Dry vs Wet Soil Drainage", y = "Study") +
    theme_light()

```

#### Precipitation

```{r filter-precip, echo = FALSE, message = FALSE}
  
srdb %>% 
  filter(grepl("^Precipitation amount change[a-z]*$", Manipulation, ignore.case = TRUE)) %>%
  distinct(Study_number) %>% 
  left_join(srdb, by = "Study_number") %>%
  group_by(Study_number) %>% 
  filter(Manipulation == "None" | 
           grepl("^Precipitation amount change[a-z]*$", Manipulation, ignore.case = TRUE)) -> precipitation

precipitation %>% 
  group_by(Ecosystem_type) %>% 
  summarise(n_studies = length(unique(Study_number))) %>% 
  mutate(M_Type = "Precipitation") %>% 
  arrange(desc(n_studies)) %>% 
  rename(Ecosystem_Type = Ecosystem_type) %>% 
  select(M_Type, Ecosystem_Type, n_studies) -> precip_summary

kable(precip_summary) %>% kable_styling(full_width = F)

precipitation %>% 
  filter(Manipulation == "None") %>% 
  group_by(Study_number, Ecosystem_type, Study_midyear) %>% 
  summarise(Rs_none = mean(Rs_annual, na.rm = TRUE)) %>% 
  filter(!is.na(Rs_none)) %>% 
  left_join(precipitation, by = c("Study_number", "Ecosystem_type", "Study_midyear")) %>% 
  mutate(rr = log(Rs_annual / Rs_none), 
         Study = paste(Author, floor(Study_midyear))) %>% 
  filter(Manipulation != "None")  -> precip_resp

  ggplot(precip_resp, aes(x = rr, y = fct_reorder(Author, rr))) + 
    geom_point(colour = "darkblue") + 
    geom_vline(xintercept = 0, linetype = "dashed") + 
    labs(x = "Response Ratio of Precipitation Change Studies", y = "Study") +
    theme_light()

```

#### Elevation

```{r filter-elevation, echo = FALSE, message = FALSE}

srdb %>%   
  group_by(Study_number) %>% 
  summarise(n_elev = length(unique(Elevation))) %>% 
  filter(n_elev > 1) %>% 
  left_join(srdb, by = "Study_number") -> elevation

elevation %>% 
  group_by(Ecosystem_type) %>% 
  summarise(n_studies = length(unique(Study_number))) %>% 
  mutate(M_Type = "Elevation") %>% 
  arrange(desc(n_studies)) %>% 
  rename(Ecosystem_Type = Ecosystem_type) %>% 
  select(M_Type, Ecosystem_Type, n_studies) -> elevat_summary

kable(elevat_summary) %>% kable_styling(full_width = F)

# elevation %>% 
#   filter(Manipulation == "None") %>% 
#   group_by(Study_number, Ecosystem_type, Study_midyear, Elevation) %>% 
#   summarise(Rs_mean = mean(Rs_annual, na.rm = TRUE)) %>% 
#   filter(!is.na(Rs_wet)) %>% 
#   left_join(drainage_type, by = c("Study_number", "Ecosystem_type", "Study_midyear")) %>% 
#   mutate(rr = log(Rs_mean / Rs_annual), 
#          Study = paste(Author, floor(Study_midyear))) -> test
# 
#   ggplot(test, aes(x = rr, y = fct_reorder(Author, rr))) + 
#     geom_point(colour = "darkblue") + 
#     geom_vline(xintercept = 0, linetype = "dashed") + 
#     labs(x = "Response Ratio of Dry vs Wet Soil Drainage", y = "Study") +
#     theme_light()

```

### Summaries

```{r summary-table, echo = FALSE, message = FALSE}

# We only want to see the number of studies for forest ecosystems 

bind_rows(irr_summary, drain_summary, precip_summary, elevat_summary) %>% 
  filter(Ecosystem_Type == "Forest") %>% kable() %>% kable_styling(full_width = F)

irrigation %>% 
  bind_rows(precipitation, drainage_type, elevat_summary) %>%
  ungroup %>% 
  filter(Ecosystem_type %in% c("Forest", "Grassland", "Agriculture"),
         Manipulation %in% c("Drought", "Irrigated", 
                             "Precipitation amount change", "None")) %>% 
  group_by(Ecosystem_type, Manipulation) %>% 
  summarise(n_Rs_annual = length(!is.na(Rs_annual)),
            n_Rs_growingseason = length(!is.na(Rs_growingseason))) %>% 
  arrange(desc(n_Rs_annual)) %>% 
  kable() %>% kable_styling(full_width = F)


```