---
title: "rs-synthesis"
output: html_document
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
# Load packages
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(kableExtra)
library(forcats)

# test change

# Read in SRDB
srdb_raw <- read_csv("./rs/srdb-data.csv")
srdb_raw %>% 
  select(Study_number, Record_number, Author, Study_midyear, Latitude, Ecosystem_type, 
         Manipulation, Manipulation_level, Meas_method,
         Rs_annual, Soil_drainage, Elevation) -> srdb

# Will turn this into a function once it works!!
# search_srdb <- function(srdb, data, column) {
#   # Function to search the Soil Respiration Database for specific data in a specified column
#   # Function will take in `srdb` (data frame of SRDB data), `data` a vector of values to search, and
#   # `column` chatacter string of the column name to search within; returns a dataframe with search results
#   
#   cat("Searching database for...", data,"...in the", column, "column")
#   
#   dplyr::filter(srdb, grepl(paste(data, collapse = "|"), x = column))
  
# }
```

##### This is a summary of the number of studies per manipulation for each ecosystem type in the SRDB.

### Manipulation Type Summaries {.tabset .tabset-pills}

#### Water manipulations

```{r filter-manipulations, echo = FALSE, message = FALSE}

# Filter for studies with water manipulations
grep_string <- "^(Irrigat[a-z]*|Drought|Precipitation amount change)$"
srdb %>% 
  # Studies with manipulations that start with "Irrigat" or "Drought" or are "Precipitation amount change"
  filter(grepl(grep_string, Manipulation, ignore.case = TRUE)) %>% 
  distinct(Study_number) %>% 
  left_join(srdb, by = "Study_number") %>%
  # Filter for rows with control and irrigation rows
  group_by(Study_number) %>% 
  filter(Manipulation == "None" |
           grepl(grep_string, Manipulation, ignore.case = TRUE))  -> water_manipulations

# Summarise and count the number of studies
water_manipulations %>% 
  group_by(Ecosystem_type) %>% 
  summarise(n_studies = length(unique(Study_number)), .groups = "drop") %>% 
  mutate(M_Type = "Water manipulation") %>% 
  arrange(desc(n_studies)) %>% 
  rename(Ecosystem_Type = Ecosystem_type) %>% 
  select(M_Type, Ecosystem_Type, n_studies) -> wm_summary

# Make table display
kable(wm_summary) %>% kable_styling(full_width = FALSE)

# Summary table
water_manipulations %>% 
  filter(Ecosystem_type %in% c("Forest", "Grassland", "Agriculture")) %>%
  group_by(Ecosystem_type, Manipulation, Manipulation_level) %>% 
  summarise(n_obs = n(), .groups = "drop")

# Read in extra (non-SRDB) data on N, treatment level, Rs s.d., and merge in
# This is the google sheet, directly downloaded
read_csv("rs/Variance and N - Water manipulations.csv", skip = 2, col_types = "ddcdcccdcddddddc") %>% 
  select(Record_number, N, SD_Rs_annual, Percent_control) %>% 
  right_join(water_manipulations, by = "Record_number") ->
  water_manipulations

# Isolate control row (manipulation of "None") and use that to compute response ratio
water_manipulations %>% 
  filter(Manipulation == "None") %>% 
  # Some studies have more than one site; latitude is a proxy for site here
  group_by(Study_number, Ecosystem_type, Study_midyear, Latitude, Meas_method) %>% 
  summarise(Rs_none = mean(Rs_annual, na.rm = TRUE),
            Rs_SD_none = mean(SD_Rs_annual, na.rm = TRUE),
            N_none = mean(N, na.rm = TRUE), .groups = "drop") %>% 
  filter(!is.na(Rs_none)) %>% 
  left_join(water_manipulations, by = c("Study_number", "Ecosystem_type",
                                        "Study_midyear", "Latitude", "Meas_method")) %>% 
  mutate(rr = log(Rs_annual / Rs_none), 
         rr_var = SD_Rs_annual ^ 2 / (N * Rs_annual ^ 2) + 
           Rs_SD_none ^ 2 / (N_none * Rs_none ^ 2),  # Eq. 1 in Hedges (1999)
         Study = paste(Study_number, Author)) %>% 
  filter(Manipulation != "None", !is.na(rr)) ->
  wm_response_ratios

  ggplot(wm_response_ratios, aes(x = rr, y = fct_reorder(Study, rr), color = Percent_control)) + 
    geom_point() + 
    geom_errorbarh(aes(xmin = rr - rr_var, xmax = rr + rr_var), na.rm = TRUE) +
    geom_vline(xintercept = 0, linetype = "dashed") + 
    labs(x = "Response Ratio of Water Manipulation Studies", y = "Study") +
    theme_light()

```

#### Contrasting Soil Drainage

```{r filter-soildrainage, echo = FALSE, message = FALSE}

drainage <- c("Dry", "Wet")
# Need studies that have BOTH dry and wet drainage 

srdb %>%   
  group_by(Study_number) %>% 
  filter(grepl(paste(drainage, collapse = "|"), x = Soil_drainage)) %>% 
  # Count the number of unique soil drainage types per study 
  summarise(n_drain = length(unique(Soil_drainage)), .groups = "drop") %>% 
  # We only want studies with 2 or more soil drainage types
  filter(n_drain > 1) %>% 
  left_join(srdb, by = "Study_number") -> drainage_type

drainage_type %>% 
  group_by(Ecosystem_type) %>% 
  summarise(n_studies = length(unique(Study_number)), .groups = "drop") %>% 
  mutate(M_Type = "Soil drainage") %>% 
  arrange(desc(n_studies)) %>% 
  rename(Ecosystem_Type = Ecosystem_type) %>% 
  select(M_Type, Ecosystem_Type, n_studies) -> drain_summary

kable(drain_summary) %>% kable_styling(full_width = FALSE)

drainage_type %>% 
  filter(Ecosystem_type %in% c("Forest", "Grassland", "Agriculture")) %>% 
  group_by(Ecosystem_type, Soil_drainage) %>% 
  summarise(n_obs = n(), .groups = "drop")

# Isolate soil "wet" row and use that as 'treatment' to compute response ratio
drainage_type %>% 
  filter(Manipulation == "None", Soil_drainage == "Wet") %>% 
  group_by(Study_number, Ecosystem_type, Study_midyear) %>% 
  summarise(Rs_wet = mean(Rs_annual, na.rm = TRUE), .groups = "drop") %>% 
  filter(!is.na(Rs_wet)) %>% 
  left_join(drainage_type, by = c("Study_number", "Ecosystem_type", "Study_midyear")) %>% 
  filter(Soil_drainage == "Dry") %>% 
  mutate(rr = log(Rs_wet / Rs_annual), 
         Study = paste(Study_number, Author)) -> drainage_resp

  ggplot(drainage_resp, aes(x = rr, y = fct_reorder(Study, rr))) + 
    geom_point(colour = "darkblue") + 
    geom_vline(xintercept = 0, linetype = "dashed") + 
    labs(x = "Response Ratio of Wet vs Dry (control) Soil Drainage", y = "Study") +
    theme_light()

```

### Summaries

```{r summary-table, echo = FALSE, message = FALSE}

# We only want to see the number of studies for forest ecosystems 

bind_rows(wm_summary, drain_summary) %>% 
  filter(Ecosystem_Type == "Forest") %>% kable() %>% kable_styling(full_width = FALSE)

water_manipulations %>% 
  bind_rows(drainage_type) %>%
  ungroup %>% 
  filter(Ecosystem_type %in% c("Forest", "Grassland", "Agriculture")) %>% 
  group_by(Ecosystem_type, Manipulation) %>% 
  summarise(n_Rs_annual = length(!is.na(Rs_annual)), .groups = "drop") %>% 
  arrange(desc(n_Rs_annual)) %>% 
  kable() %>% kable_styling(full_width = FALSE)
```
